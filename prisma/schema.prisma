generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String                @id @default(cuid())
  name                  String?
  email                 String                @unique
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  sessionVersion        Int                   @default(0)
  role                  UserRole              @default(STUDENT)
  isOwner               Boolean               @default(false)
  emailVerified         DateTime?
  image                 String?
  password              String?
  subscriptionType      SubscriptionType      @default(FREE)
  subscriptionExpiresAt DateTime?
  trialStartedAt        DateTime?
  trialExpiresAt        DateTime?
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  creditBalance         Int                   @default(0)
  monthlyCredits        Int                   @default(0)
  accounts              Account[]
  courses               Course[]              @relation("InstructorCourses")
  creditTransactions    CreditTransaction[]
  posts                 DiscussionPost[]
  enrollments           Enrollment[]
  gradesGiven           Grade[]               @relation("Grader")
  gradingActivities     GradingActivity[]
  organizationMembers   OrganizationMember[]
  professorProfile      ProfessorProfile?
  professorStyle        ProfessorStyle?       @relation("ProfessorStyleProfile")
  sessions              Session[]
  studentProfile        StudentProfile?
  submissions           Submission[]
  subscription          Subscription?
  subscriptionFeatures  SubscriptionFeature[]
  userSubscription      UserSubscription?
  userUsage             UserUsageCounter?
  presentations         Presentation[]        @relation("UserPresentations")
  aiSettings            UserAISettings?
  notifications         Notification[]
}

// User's custom AI provider settings (Bring Your Own Key - BYOK)
model UserAISettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  // Preferred provider selection
  preferredProvider     String?  @default("platform") // "platform", "openai", "anthropic", etc.
  usePlatformFallback   Boolean  @default(true)
  // Encrypted API keys for each provider
  openaiApiKey          String?  // Encrypted
  anthropicApiKey       String?  // Encrypted
  geminiApiKey          String?  // Encrypted
  groqApiKey            String?  // Encrypted
  perplexityApiKey      String?  // Encrypted
  cohereApiKey          String?  // Encrypted
  huggingfaceApiKey     String?  // Encrypted
  // Provider preferences
  openaiModel           String?  @default("gpt-4o-mini")
  anthropicModel        String?  @default("claude-3-haiku-20240307")
  // Settings
  isEnabled             Boolean  @default(false) // Whether to use custom keys
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_ai_settings")
}

model Course {
  id            String             @id @default(cuid())
  title         String
  code          String?
  term          String?
  description   String?
  instructorId  String
  isPublic      Boolean            @default(false)
  durationWeeks Int?               @default(16) // Flexible: 8-16 weeks or more
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  assignments   Assignment[]
  instructor    User               @relation("InstructorCourses", fields: [instructorId], references: [id])
  discussions   DiscussionThread[]
  enrollments   Enrollment[]
  modules       Module[]
  presentations Presentation[]
  designMetadata CourseDesignMetadata?
  notifications  Notification[]
}

model Enrollment {
  id       String @id @default(cuid())
  courseId String
  userId   String
  course   Course @relation(fields: [courseId], references: [id])
  user     User   @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
}

model Module {
  id          String          @id @default(cuid())
  courseId    String
  title       String
  description String?
  weekNo      Int? // Optional week number
  sectionNo   Int? // Section number (unlimited sections)
  orderIndex  Int             @default(0) // For custom ordering
  content     String? // Rich text content
  isPublished Boolean         @default(false)
  dueDate     DateTime?       // Module completion deadline
  startDate   DateTime?       // Module start date
  objectives  String?         // JSON array of learning objectives for this module
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  course      Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  contents    ModuleContent[] // Files, assignments, links, pages
  sections    ModuleSection[] // Sub-sections within module
}

// Module Sections - Sub-divisions within a module
model ModuleSection {
  id          String    @id @default(cuid())
  moduleId    String
  title       String
  description String?
  content     String?   // Rich text content
  orderIndex  Int       @default(0)
  dueDate     DateTime?
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  module      Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId, orderIndex])
  @@map("module_sections")
}

model Presentation {
  id             String                   @id @default(cuid())
  courseId       String
  userId         String
  title          String
  description    String?
  sourceType     PresentationSource       @default(MIXED)
  templateStyle  String                   @default("modern-minimalist")
  slideCount     Int                      @default(0)
  targetDuration Int? // in minutes
  status         PresentationStatus       @default(DRAFT)
  fileUrl        String?
  pdfUrl         String?
  previewUrl     String?
  metadata       String? // JSON metadata
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  course         Course                   @relation(fields: [courseId], references: [id])
  user           User                     @relation("UserPresentations", fields: [userId], references: [id])
  slides         PresentationSlide[]
  sources        PresentationSourceFile[]
}

model PresentationSlide {
  id             String       @id @default(cuid())
  presentationId String
  slideNumber    Int
  title          String?
  content        String? // JSON content
  notes          String?
  layout         String       @default("title-content")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@unique([presentationId, slideNumber])
}

model PresentationSourceFile {
  id             String       @id @default(cuid())
  presentationId String
  fileName       String
  fileType       String
  fileUrl        String
  fileSize       Int?
  pages          String? // e.g., "1-10,15,20-25"
  createdAt      DateTime     @default(now())
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)
}

model ModuleContent {
  id           String      @id @default(cuid())
  moduleId     String
  type         ContentType
  title        String
  description  String?
  content      String? // For pages/text content
  fileUrl      String? // For file uploads
  fileName     String?
  fileSize     Int?
  fileType     String?
  linkUrl      String? // For external links
  assignmentId String? // Link to existing assignment
  orderIndex   Int         @default(0)
  isRequired   Boolean     @default(true)
  points       Int? // For gradable content
  dueDate      DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  module       Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  assignment   Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
}

model Assignment {
  id                    String          @id @default(cuid())
  courseId              String
  lmsId                 String?
  title                 String
  type                  AssignmentType  @default(OTHER)
  instructions          String?
  points                Int             @default(100)
  dueAt                 DateTime?       // Final submission deadline
  preSubmissionDeadline DateTime?       // Early/draft submission deadline
  gradingDeadline       DateTime?       // Instructor grading deadline
  lateSubmissionAllowed Boolean         @default(false)
  latePenaltyPercent    Int?            // e.g., 10 = 10% penalty per day
  reminderSent          Boolean         @default(false)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  course                Course          @relation(fields: [courseId], references: [id])
  rubric                Rubric?
  submissions           Submission[]
  moduleContents        ModuleContent[] // Reverse relation
  notifications         Notification[]  // Related notifications

  @@unique([courseId, lmsId], name: "courseId_lmsId")
}

model Rubric {
  id           String            @id @default(cuid())
  assignmentId String            @unique
  assignment   Assignment        @relation(fields: [assignmentId], references: [id])
  criteria     RubricCriterion[]
}

model RubricCriterion {
  id        String @id @default(cuid())
  rubricId  String
  label     String
  maxPoints Int
  order     Int
  rubric    Rubric @relation(fields: [rubricId], references: [id])
}

model Submission {
  id                String            @id @default(cuid())
  assignmentId      String
  studentId         String
  status            SubmissionStatus  @default(SUBMITTED)
  content           String?
  contentText       String?
  fileUrl           String?
  submittedAt       DateTime          @default(now())
  gradedAt          DateTime?
  grade             Grade?
  gradingActivities GradingActivity[]
  assignment        Assignment        @relation(fields: [assignmentId], references: [id])
  student           User              @relation(fields: [studentId], references: [id])
}

model Grade {
  id           String     @id @default(cuid())
  submissionId String     @unique
  graderId     String
  score        Float
  feedback     String?
  grader       User       @relation("Grader", fields: [graderId], references: [id])
  submission   Submission @relation(fields: [submissionId], references: [id])
}

model DiscussionThread {
  id        String           @id @default(cuid())
  courseId  String
  title     String
  prompt    String?
  dueDate   DateTime?        // When discussion responses are due
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  posts     DiscussionPost[]
  course    Course           @relation(fields: [courseId], references: [id])
}

model DiscussionPost {
  id        String              @id @default(cuid())
  threadId  String
  authorId  String
  body      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  author    User                @relation(fields: [authorId], references: [id])
  thread    DiscussionThread    @relation(fields: [threadId], references: [id])
  feedback  DiscussionFeedback?
}

// AI-Generated Discussion Feedback
model DiscussionFeedback {
  id                String           @id @default(cuid())
  postId            String           @unique
  professorId       String
  // AI-generated content
  aiFeedback        String           // The generated feedback text
  aiScore           Float?           // Optional numeric score (e.g., 0-100)
  aiStrengths       String[]         // Identified strengths
  aiImprovements    String[]         // Suggested improvements
  aiProvider        String?          // Which AI provider was used
  // Professor customization
  professorEdits    String?          // Professor's edited version
  finalFeedback     String?          // Final feedback (edited or original)
  finalScore        Float?           // Final score after professor review
  isApproved        Boolean          @default(false)
  approvedAt        DateTime?
  // Professor style used
  gradingDifficulty String?          // EASY, MEDIUM, HARD
  feedbackDepth     String?          // LIGHT, MODERATE, COMPREHENSIVE, DEEP
  personality       String?          // ENCOURAGING, CRITICAL, ANALYTICAL, etc.
  // Metadata
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  post              DiscussionPost   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([professorId])
  @@index([createdAt])
}

// Notification System - For due dates, submissions, grades
model Notification {
  id              String             @id @default(cuid())
  userId          String
  type            NotificationType
  title           String
  message         String
  isRead          Boolean            @default(false)
  isEmailSent     Boolean            @default(false)
  // Related entities
  courseId        String?
  assignmentId    String?
  submissionId    String?
  // Scheduling
  scheduledFor    DateTime?          // For scheduled notifications
  sentAt          DateTime?
  // Metadata
  data            String?            // JSON additional data
  priority        NotificationPriority @default(NORMAL)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course?            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignment      Assignment?        @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([type, scheduledFor])
  @@map("notifications")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  id                String  @id @default(cuid())
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Subscription {
  id             String             @id @default(cuid())
  userId         String             @unique
  type           SubscriptionType   @default(FREE)
  status         SubscriptionStatus @default(TRIALING)
  trialExpiresAt DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model Organization {
  id                    String                    @id @default(cuid())
  name                  String
  domain                String?                   @unique
  subscriptionType      SubscriptionType          @default(FREE)
  subscriptionExpiresAt DateTime?
  creditBalance         Int                       @default(0)
  monthlyCredits        Int                       @default(0)
  settings              Json?
  customizations        Json?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  creditTransactions    CreditTransaction[]
  subscription          OrgSubscription?
  usage                 OrgUsageCounter?
  members               OrganizationMember[]
  usageCounters         OrganizationUsageCounter?
}

model OrganizationMember {
  id        String       @id @default(cuid())
  orgId     String
  userId    String
  orgRole   OrgRole      @default(MEMBER)
  createdAt DateTime     @default(now())
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
}

model OrgSubscription {
  id                   String             @id @default(cuid())
  orgId                String             @unique
  tier                 SubscriptionTier   @default(FREE_TRIAL)
  status               SubscriptionStatus @default(TRIALING)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  org                  Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model OrgUsageCounter {
  id                   String       @id @default(cuid())
  orgId                String       @unique
  periodStart          DateTime     @default(now())
  studentsCount        Int          @default(0)
  coursesCount         Int          @default(0)
  assignmentsCount     Int          @default(0)
  aiGradesCount        Int          @default(0)
  plagiarismScansCount Int          @default(0)
  org                  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model UserSubscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  tier                 SubscriptionTier   @default(FREE_TRIAL)
  status               SubscriptionStatus @default(TRIALING)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserUsageCounter {
  id                   String   @id @default(cuid())
  userId               String   @unique
  periodStart          DateTime @default(now())
  coursesCount         Int      @default(0)
  assignmentsCount     Int      @default(0)
  aiGradesCount        Int      @default(0)
  plagiarismScansCount Int      @default(0)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Invitation {
  id        String           @id @default(cuid())
  email     String           @unique
  role      UserRole         @default(STUDENT)
  status    InvitationStatus @default(PENDING)
  invitedBy String?
  createdAt DateTime         @default(now())
  expiresAt DateTime?
}

model ProfessorProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  institution       String?
  department        String?
  officeHours       String?
  bio               String?
  researchInterests String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model StudentProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  studentId String?
  section   String?
  major     String?
  year      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SubscriptionFeature {
  id          String      @id @default(cuid())
  userId      String
  featureType FeatureType
  limit       Int         @default(-1)
  isEnabled   Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureType])
}

model ProfessorStyle {
  id                    String               @id @default(cuid())
  professorId           String               @unique
  gradingDifficulty     GradingDifficulty    @default(MEDIUM)
  feedbackDepth         FeedbackDepth        @default(MODERATE)
  personality           ProfessorPersonality @default(SUPPORTIVE)
  customPromptTemplate  String?
  keyEvaluationCriteria String[]
  learningPreferences   Json?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  professor             User                 @relation("ProfessorStyleProfile", fields: [professorId], references: [id])
}

model CreditTransaction {
  id             String        @id @default(cuid())
  userId         String?
  organizationId String?
  amount         Int
  type           CreditType
  description    String?
  featureType    FeatureType?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
}

model OrganizationUsageCounter {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  periodStart          DateTime
  studentsCount        Int          @default(0)
  coursesCount         Int          @default(0)
  assignmentsCount     Int          @default(0)
  aiGradesCount        Int          @default(0)
  plagiarismScansCount Int          @default(0)
  organization         Organization @relation(fields: [organizationId], references: [id])
}

model GradingActivity {
  id           String     @id @default(cuid())
  submissionId String
  userId       String
  activityType String
  details      String
  createdAt    DateTime   @default(now())
  submission   Submission @relation(fields: [submissionId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@index([submissionId, activityType])
  @@index([userId, createdAt])
}

model AdminConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String?
  description String?
  category    String
  isActive    Boolean  @default(true)
  isRequired  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  @@map("admin_configs")
}

// =============================================================================
// COURSE DESIGN STUDIO - Full Governance Model
// =============================================================================

// Phase 0.5: Course Details & Bulk Course Information
model CourseDesignMetadata {
  id                   String               @id @default(cuid())
  courseId             String               @unique
  // Core Course Information
  creditHours          Int?                 @default(3)
  contactHours         Int?                 @default(3)
  academicLevel        AcademicLevel        @default(UNDERGRADUATE)
  termLength           Int                  @default(16) // weeks
  deliveryMode         DeliveryMode         @default(ONLINE)
  prerequisites        String?              // JSON array of prerequisite course codes
  programAlignment     String?              // Program/degree this course belongs to
  // Instructional Parameters
  learningModel        LearningModel        @default(LECTURE)
  assessmentWeighting  String?              // JSON: {exam: 40, assignments: 30, participation: 30}
  participationRules   String?
  weeklyWorkloadHours  Int?                 @default(9)
  // Governance & Standards
  formattingStandard   FormattingStandard   @default(APA)
  accessibilityRequired Boolean             @default(true)
  aiUsagePolicy        AIUsagePolicy        @default(PERMITTED_WITH_DISCLOSURE)
  accreditationBody    String?
  // Versioning
  versionId            String               @default(cuid())
  isLocked             Boolean              @default(false)
  lockedAt             DateTime?
  lockedBy             String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  course               Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  evidenceItems        EvidenceKitItem[]
  courseObjectives     CourseObjective[]
  courseSections       CourseDesignSection[]
  readyChecks          ReadyCheckResult[]
  auditLogs            CourseAuditLog[]
  syllabusVersions     SyllabusVersion[]
  
  @@map("course_design_metadata")
}

// Phase 1: Evidence Kit - Material Ingestion & Storage
model EvidenceKitItem {
  id                   String               @id @default(cuid())
  courseDesignId       String
  // File Information
  title                String
  fileName             String
  fileType             EvidenceFileType
  fileUrl              String
  fileSize             Int?
  mimeType             String?
  // Content Analysis (AI-generated)
  extractedText        String?              // OCR/parsed text
  contentSummary       String?              // AI summary
  topicsIdentified     String?              // JSON array of topics
  conceptsMapping      String?              // JSON mapping of concepts
  citationsFound       String?              // JSON array of citations
  pageCount            Int?
  chapterMapping       String?              // JSON: {chapter: pages}
  // Source Indexing
  sourceType           EvidenceSourceType   @default(TEXTBOOK)
  isbn                 String?              // For textbooks
  doi                  String?              // For articles
  externalUrl          String?              // For web content
  // Governance
  uploadedBy           String
  isProcessed          Boolean              @default(false)
  processingStatus     ProcessingStatus     @default(PENDING)
  processingError      String?
  semanticChunks       String?              // JSON array of semantic chunks with embeddings
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  courseDesign         CourseDesignMetadata @relation(fields: [courseDesignId], references: [id], onDelete: Cascade)
  sectionContents      SectionContent[]
  citationLinks        CitationLink[]
  
  @@index([courseDesignId, fileType])
  @@map("evidence_kit_items")
}

// Citation tracking for governance
model CitationLink {
  id                   String             @id @default(cuid())
  evidenceItemId       String
  targetType           String             // objective, section, lecture_note, etc.
  targetId             String
  pageReference        String?            // e.g., "pp. 45-52"
  formattedCitation    String             // APA/MLA formatted
  inTextCitation       String             // (Author, Year, p. X)
  createdAt            DateTime           @default(now())
  
  evidenceItem         EvidenceKitItem    @relation(fields: [evidenceItemId], references: [id], onDelete: Cascade)
  
  @@index([targetType, targetId])
  @@map("citation_links")
}

// Phase 3: Course Objectives with Bloom's Taxonomy
model CourseObjective {
  id                   String               @id @default(cuid())
  courseDesignId       String
  objectiveNumber      String               // e.g., "1.1", "2.3"
  description          String
  bloomsLevel          BloomsLevel          @default(UNDERSTAND)
  assessmentMethod     String?              // How this will be assessed
  alignedModules       String?              // JSON array of module IDs
  sourceEvidence       String?              // Evidence Kit item IDs
  isAIGenerated        Boolean              @default(false)
  isApproved           Boolean              @default(false)
  approvedBy           String?
  approvedAt           DateTime?
  orderIndex           Int                  @default(0)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  courseDesign         CourseDesignMetadata @relation(fields: [courseDesignId], references: [id], onDelete: Cascade)
  
  @@map("course_objectives")
}

// Phase 4 & 5: Course Structure - Drag & Drop Sections
model CourseDesignSection {
  id                   String               @id @default(cuid())
  courseDesignId       String
  parentSectionId      String?              // For nested modules
  title                String
  description          String?
  sectionType          DesignSectionType    @default(MODULE)
  weekNumber           Int?
  orderIndex           Int                  @default(0)
  isPublished          Boolean              @default(false)
  durationMinutes      Int?                 // Estimated time
  learningOutcomes     String?              // JSON array linked to objectives
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  courseDesign         CourseDesignMetadata @relation(fields: [courseDesignId], references: [id], onDelete: Cascade)
  parentSection        CourseDesignSection? @relation("ChildSections", fields: [parentSectionId], references: [id])
  childSections        CourseDesignSection[] @relation("ChildSections")
  contents             SectionContent[]
  
  @@index([courseDesignId, orderIndex])
  @@map("course_design_sections")
}

// Content within sections (files + AI content)
model SectionContent {
  id                   String               @id @default(cuid())
  sectionId            String
  evidenceItemId       String?              // Link to Evidence Kit
  contentType          SectionContentType
  title                String
  description          String?
  content              String?              // Rich text/HTML content
  aiGeneratedContent   String?              // AI lecture notes, etc.
  isAIGenerated        Boolean              @default(false)
  orderIndex           Int                  @default(0)
  isRequired           Boolean              @default(true)
  dueDate              DateTime?
  points               Int?
  // AI Content Review
  reviewStatus         ReviewStatus         @default(PENDING)
  reviewedBy           String?              // User ID who reviewed
  reviewedAt           DateTime?
  reviewNotes          String?              // Professor/admin feedback
  // Governance
  citationRequired     Boolean              @default(false)
  aiDisclosureAdded    Boolean              @default(false)
  wcagCompliant        Boolean?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  section              CourseDesignSection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  evidenceItem         EvidenceKitItem?     @relation(fields: [evidenceItemId], references: [id])
  rubric               AssessmentRubric?
  
  @@map("section_contents")
}

// Phase 6: Assessment Rubrics
model AssessmentRubric {
  id                   String               @id @default(cuid())
  sectionContentId     String               @unique
  title                String
  description          String?
  totalPoints          Int                  @default(100)
  criteria             String               // JSON array of criteria with levels
  isAIGenerated        Boolean              @default(false)
  alignedObjectives    String?              // Objective IDs
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  sectionContent       SectionContent       @relation(fields: [sectionContentId], references: [id], onDelete: Cascade)
  
  @@map("assessment_rubrics")
}

// Phase 7: Syllabus Versioning
model SyllabusVersion {
  id                   String               @id @default(cuid())
  courseDesignId       String
  version              Int                  @default(1)
  status               SyllabusStatus       @default(DRAFT)
  content              String               // Full syllabus HTML/Markdown
  pdfUrl               String?
  wordUrl              String?
  // Compilation Sources
  compiledFrom         String?              // JSON: sections, objectives, policies
  // Governance
  academicPolicies     String?              // JSON academic integrity, etc.
  aiDisclosure         String?              // AI usage policy text
  accessibilityStatement String?
  // Approval
  isApproved           Boolean              @default(false)
  approvedBy           String?
  approvedAt           DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  courseDesign         CourseDesignMetadata @relation(fields: [courseDesignId], references: [id], onDelete: Cascade)
  
  @@unique([courseDesignId, version])
  @@map("syllabus_versions")
}

// Phase 8: Ready-Check Validation
model ReadyCheckResult {
  id                   String               @id @default(cuid())
  courseDesignId       String
  checkType            ReadyCheckType
  status               ReadyCheckStatus     @default(PENDING)
  score                Float?               // 0-100
  issues               String?              // JSON array of issues
  suggestions          String?              // JSON array of suggestions
  details              String?              // Detailed report
  createdAt            DateTime             @default(now())
  
  courseDesign         CourseDesignMetadata @relation(fields: [courseDesignId], references: [id], onDelete: Cascade)
  
  @@index([courseDesignId, checkType])
  @@map("ready_check_results")
}

// Audit Log for all AI and user actions
model CourseAuditLog {
  id                   String               @id @default(cuid())
  courseDesignId       String
  userId               String
  action               AuditAction
  targetType           String               // objective, section, syllabus, etc.
  targetId             String?
  previousValue        String?              // JSON before
  newValue             String?              // JSON after
  aiProvider           String?              // Which AI provider was used
  aiPrompt             String?              // Governed prompt (sanitized)
  createdAt            DateTime             @default(now())
  
  courseDesign         CourseDesignMetadata @relation(fields: [courseDesignId], references: [id], onDelete: Cascade)
  
  @@index([courseDesignId, action])
  @@index([userId, createdAt])
  @@map("course_audit_logs")
}

// Prompt Governance Audit Log (IEEE SRS FR-34)
model PromptAuditLog {
  id                   String               @id @default(cuid())
  promptId             String               @unique // PG-{timestamp}-{random}
  userId               String
  userRole             UserRole
  toolInvoked          String               // Which AI tool was invoked
  promptType           PromptType           // ADVISORY, GENERATION, VALIDATION, EXPORT
  courseId             String?
  metadataSnapshotId   String?              // Foreign key to metadata version
  evidenceSnapshotId   String?              // Hash of evidence kit state
  aiModel              String?              // Which AI model processed the request
  inputHash            String?              // Hash of governed prompt
  outputHash           String?              // Hash of AI response
  decision             GovernanceDecision   // ALLOW, BLOCK, ESCALATE
  blockReason          String?
  timestamp            DateTime             @default(now())
  
  @@index([userId, timestamp])
  @@index([courseId, timestamp])
  @@index([toolInvoked])
  @@index([decision])
  @@map("prompt_audit_logs")
}

// Prompt Type Enum
enum PromptType {
  ADVISORY
  GENERATION
  VALIDATION
  EXPORT
}

// Governance Decision Enum
enum GovernanceDecision {
  ALLOW
  BLOCK
  ESCALATE
}

// Ask Professor GENIE Conversations
model GenieConversation {
  id                   String               @id @default(cuid())
  courseId             String
  userId               String
  context              String?              // JSON: current phase, section, etc.
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  messages             GenieMessage[]
  
  @@index([courseId, userId])
  @@map("genie_conversations")
}

model GenieMessage {
  id                   String               @id @default(cuid())
  conversationId       String
  role                 String               // user, assistant
  content              String
  context              String?              // JSON: phase, references
  createdAt            DateTime             @default(now())
  
  conversation         GenieConversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@map("genie_messages")
}

// =============================================================================
// ENUMS FOR COURSE DESIGN STUDIO
// =============================================================================

enum AcademicLevel {
  UNDERGRADUATE
  GRADUATE
  DOCTORAL
  PROFESSIONAL
  CERTIFICATE
}

enum DeliveryMode {
  ONLINE
  HYBRID
  IN_PERSON
  HYFLEX
}

enum LearningModel {
  LECTURE
  CASE_BASED
  PROJECT_BASED
  FLIPPED
  SEMINAR
  LAB
  PRACTICUM
  MIXED
}

enum FormattingStandard {
  APA
  MLA
  CHICAGO
  HARVARD
  IEEE
  INSTITUTIONAL
}

enum AIUsagePolicy {
  NOT_PERMITTED
  PERMITTED_WITH_DISCLOSURE
  PERMITTED_ALL
  COURSE_SPECIFIC
}

enum EvidenceFileType {
  TEXTBOOK
  ARTICLE
  LECTURE_SLIDES
  VIDEO
  NOTES
  SYLLABUS
  RUBRIC
  EXTERNAL_LINK
  OTHER
}

enum EvidenceSourceType {
  TEXTBOOK
  JOURNAL_ARTICLE
  CONFERENCE_PAPER
  WEB_RESOURCE
  VIDEO_LECTURE
  INSTRUCTOR_NOTES
  INSTITUTIONAL_POLICY
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum BloomsLevel {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

enum DesignSectionType {
  MODULE
  WEEK
  UNIT
  CHAPTER
  LESSON
  PAGE
}

enum SectionContentType {
  LECTURE
  READING
  ASSIGNMENT
  QUIZ
  DISCUSSION
  VIDEO
  EXTERNAL_LINK
  RESOURCE
  PROJECT
}

enum SyllabusStatus {
  DRAFT
  REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum ReadyCheckType {
  OBJECTIVE_COVERAGE
  CITATION_COMPLIANCE
  ACCESSIBILITY_WCAG
  AI_DISCLOSURE
  POLICY_COMPLETENESS
  CONTENT_ALIGNMENT
  WORKLOAD_BALANCE
}

enum ReadyCheckStatus {
  PENDING
  PASSED
  FAILED
  WARNING
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  AI_GENERATE
  AI_REFINE
  APPROVE
  PUBLISH
  REVERT
  IMPORT
  EXPORT
}

model SystemHealth {
  id           String    @id @default(cuid())
  service      String    @unique
  status       String
  lastTested   DateTime?
  lastError    String?
  responseTime Int?
  version      String?
  metadata     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("system_health")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum FeatureType {
  COURSE_CREATION
  ASSIGNMENT_CREATION
  DISCUSSION_CREATION
  CUSTOM_RUBRICS
  AI_GRADING
  ADVANCED_ANALYTICS
  BULK_OPERATIONS
  API_ACCESS
  PLAGIARISM_DETECTION
  PROFESSOR_STYLE_LEARNING
  ORGANIZATION_MANAGEMENT
}

enum UserRole {
  ADMIN
  PROFESSOR
  STUDENT
}

enum AssignmentType {
  ESSAY
  QUIZ
  DISCUSSION
  PROJECT
  CASE_STUDY
  OTHER
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  RETURNED
}

enum SubscriptionType {
  FREE
  BASIC
  PREMIUM
}

enum SubscriptionTier {
  FREE_TRIAL
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum GradingDifficulty {
  EASY
  MEDIUM
  HARD
}

enum FeedbackDepth {
  LIGHT
  MODERATE
  DEEP
  COMPREHENSIVE
}

enum AssessmentType {
  ASSIGNMENT
  PAPER
  DISSERTATION
  EXAM
  QUIZ
  PROJECT
}

enum ProfessorPersonality {
  ENCOURAGING
  CRITICAL
  ANALYTICAL
  SUPPORTIVE
  DETAILED
  CONCISE
}

enum CreditType {
  PURCHASE
  USAGE
  ROLLOVER
  BONUS
  REFUND
}

enum PresentationSource {
  TEXTBOOK
  LECTURE_NOTES
  RESEARCH_PAPER
  WEB_CONTENT
  MIXED
}

enum PresentationStatus {
  DRAFT
  PROCESSING
  COMPLETED
  FAILED
  EXPORTED
}

enum ContentType {
  FILE // Uploaded files (PDF, DOCX, etc.)
  ASSIGNMENT // Assignment/homework
  LINK // External URL
  PAGE // Text/HTML page content
  VIDEO // Video content
  QUIZ // Quiz/test
  DISCUSSION // Discussion topic
}

// Notification Types
enum NotificationType {
  // Assignment notifications
  ASSIGNMENT_CREATED
  ASSIGNMENT_DUE_SOON      // 24-48 hours before due
  ASSIGNMENT_DUE_TODAY
  ASSIGNMENT_OVERDUE
  PRE_SUBMISSION_REMINDER  // Pre-submission deadline reminder
  
  // Grading notifications  
  GRADE_POSTED
  GRADING_DEADLINE_SOON    // Reminder for instructors
  FEEDBACK_AVAILABLE
  
  // Submission notifications
  SUBMISSION_RECEIVED
  SUBMISSION_GRADED
  
  // Course notifications
  COURSE_PUBLISHED
  SYLLABUS_UPDATED
  MODULE_PUBLISHED
  
  // AI Content notifications
  AI_CONTENT_READY         // AI-generated content ready for review
  AI_CONTENT_APPROVED
  AI_CONTENT_REJECTED
  
  // General
  ENROLLMENT_CONFIRMED
  SYSTEM_ANNOUNCEMENT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Review Status for AI-generated content
enum ReviewStatus {
  PENDING           // Awaiting review
  APPROVED          // Approved by professor/admin
  REJECTED          // Rejected, needs changes
  REVISION_REQUESTED // Requires revision
  PUBLISHED         // Approved and published
}
